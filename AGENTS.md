# AGENTS.md (Refined)

## 言語設定
- 特に指定がない限り日本語で応答する。

---

## プロジェクト概要
ガントチャートベースの進捗管理・報告アプリ。ブラウザのみで動作し、localStorageでデータを永続化。

## 技術スタック
- Vanilla JavaScript（フレームワーク不使用）
- Bulma CSS + bulma-prefers-dark（常時ダークモード）
- Frappe Gantt（ドラッグ＆リサイズ対応）
- Jest（テスト）
- Node.js v25.2.1（mise管理）

## コマンド
```bash
npm test              # 全テスト実行
npm test -- --watch   # ウォッチモード
npm test -- __tests__/state.test.js  # 単一ファイル実行
```

## ファイル構成
```
├── index.html          # エントリーポイント
├── css/
│   ├── bulma.min.css, bulma-prefers-dark.min.css, frappe-gantt.css
│   └── app.css         # カスタムCSS（最小限）
├── js/
│   ├── frappe-gantt.min.js
│   ├── state.js        # 状態管理・永続化
│   ├── gantt.js        # ガントチャート操作
│   ├── report.js       # 進捗報告生成
│   └── main.js         # エントリーポイント
├── __tests__/          # Jestテスト
└── package.json
```

## アーキテクチャ
- **AppState**: 単一オブジェクトで全状態を管理（projects, tasks, workLogs, adhocTasks, uiPreferences）
- **永続化**: `state.js`の`loadState()`/`saveState()`でlocalStorageと同期
- **ID生成**: `crypto.randomUUID()`（UUID v4）

## 重要な実装パターン
- ガントバーのドラッグ/リサイズは Frappe Gantt の `on_date_change` コールバックで処理
- 自動保存はデバウンス付き（500〜2000ms）
- 日付は全て`YYYY-MM-DD`形式の文字列

---

## AI自身の心構え
- ユーザーの理解と学習を助けることを最優先する。
- 思い込みを避け、LLMとしての限界を自覚しつつ複数案を比較検討する。
- 作業後の学びと改善案は、後述のメモ運用に沿って残す。

## 学びメモ運用
- 作業後の学び・改善案を `improvement-notes.md` に簡潔に記録する。
- ガイドライン本体への反映はユーザー合意後に行い、無断で改変しない。

## 基本方針
- ユーザー要求の範囲で最小限かつ安全に解決し、不要な機能や複雑さを加えない。
- 依頼が曖昧なら確認し、仕様を勝手に足さない。
- セキュリティ脆弱性、明らかなバグ、非効率な実装を発見したら積極的に指摘する。

## 作業プロセス
- 複数ステップなら簡潔なプランを先に共有してから実行する。
- コード変更前にファイル全体を読み、完全に理解してから編集する。
- 変更は「失敗テスト再現 → 最小修正 → 既存テスト確認」の順。
- 何を・なぜ変えたかと検証手順を必ず記録する。
- ファイルは単一責務とし、目安は 300 行未満に保つ。
- テストがなければ追加し、既存テストは必ず通す。

## コード品質
- クリーンでモジュール化された実装を選び、過剰設計を避ける。
- 既存パターン・命名規則・フォーマットに合わせる。
- エラーは適切に処理し、ユーザーに分かりやすく伝える。
- 外部依存の追加は理由を示し、軽量で保守されたものを選ぶ。

## ドキュメント
- 自明でない処理には短いコメントを添える。
- ファイル冒頭に以下4行のヘッダーを推奨：
  1. パス
  2. 役割
  3. 存在理由
  4. 関連ファイル2〜4件
- 既存ヘッダーは削除しない。

## ファイル形式
- UTF-8（BOMなし）、改行は LF で統一する。

## Git / CI
- ブランチ切替は `switch`、ファイル復元は `restore` を推奨する。
- 新規ブランチは最新の `dev` で `git switch -c <topic>` して切る。
- 初回の push は `git push -u origin <topic>` を使い、仕向け先を設定する。
- 既存のリモートブランチは `git fetch origin` のあと `git switch <branch>` で切り替える（上流は自動設定される）。
- 作業は `dev` 配下のトピックブランチで行い、`main` へ直接 push しない。
- コミットは簡潔な命令形で理由を含める。WIP は避け、小さく刻む。
- `dev` → `main` は PR 経由で、最低1名のレビューを通す。
- PR・Issue の操作は環境に応じた CLI ツール（例: gh, glab 等）を許容する。
- `dev` を定期的にリベース/マージし、差分を小さく保つ。
- `main` は保護ブランチ（強制 push 禁止）。

## 制約事項
- 提案の実装は承認後に行う。
- コミットは指示または承認後のみ、プッシュは明示指示があるまで行わない。
- 重いビルド/テストは指示なしに実行しない。
- DB マイグレーションや本番データ変更は提案のみで、実行しない。
- 秘密情報は回答・ログに残さず、外部共有前に再確認する。

## 出力スタイル
- したこと・必要なこと・次のステップを簡潔に伝える。
- リスクや代替案はトレードオフとともに伝える。
- パスは `path/to/file:line` 形式で示す。
- 長文は避け、改行と箇条書きを使う。

## 環境・リポジトリ構成
- リポジトリは `~/dev/github.com/<ユーザー名>/<リポジトリ名>` 配下で管理する。
